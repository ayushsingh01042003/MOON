<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Path Visualization</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: #000;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #coordinateInputs, #locationNavigator {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            width: 320px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 
                        0 10px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        #coordinateInputs {
            top: 20px;
            left: 20px;
        }

        #locationNavigator {
            top: 20px;
            right: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group:last-of-type {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a1a1a;
            font-size: 0.9rem;
        }

        .coordinate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .input-group input::placeholder {
            color: #999;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .cesium-viewer-bottom {
            display: none;
        }
    </style>
</head>
<body>
    <div id="coordinateInputs">
        <div class="input-group">
            <label>Starting Point</label>
            <div class="coordinate-inputs">
                <input type="number" id="startLat" placeholder="Latitude" step="any">
                <input type="number" id="startLon" placeholder="Longitude" step="any">
            </div>
        </div>
        <div class="input-group">
            <label>Ending Point</label>
            <div class="coordinate-inputs">
                <input type="number" id="endLat" placeholder="Latitude" step="any">
                <input type="number" id="endLon" placeholder="Longitude" step="any">
            </div>
        </div>
        <button onclick="generatePath()">Generate Path</button>
    </div>
    <div id="locationNavigator">
        <div class="input-group">
            <label>Navigate to Location</label>
            <div class="coordinate-inputs">
                <input type="number" id="navLat" placeholder="Latitude" step="any">
                <input type="number" id="navLon" placeholder="Longitude" step="any">
            </div>
        </div>
        <button onclick="navigateToLocation()">Go to Location</button>
    </div>
    <div id="cesiumContainer"></div>
    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI4MDc1NzZkZi1mNzc1LTRhYmEtYmMwZi01MjE0NzQ0ZjdhZWIiLCJpZCI6MjU0NzEzLCJpYXQiOjE3MzE0MTYyOTZ9.IbhV6cYW_PlSq7T5nLlPPDVEC8jGY7l51WHvkw7AHjc';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            shadows: true
        });

        viewer.scene.globe.show = false;

        let pathEntity = null;
        let pointEntities = [];

        const MOON_RADIUS = 1737100;
        const PATH_ELEVATION = 5000; // 100 meters above surface
        const MOON_ELLIPSOID = new Cesium.Ellipsoid(MOON_RADIUS, MOON_RADIUS, MOON_RADIUS);

        function clearEntities() {
            if (pathEntity) {
                viewer.entities.remove(pathEntity);
            }
            pointEntities.forEach(entity => viewer.entities.remove(entity));
            pointEntities = [];
        }

        function createCartesianPoint(latitude, longitude) {
            const latRad = Cesium.Math.toRadians(latitude);
            const lonRad = Cesium.Math.toRadians(longitude);
            const cartographic = new Cesium.Cartographic(lonRad, latRad, PATH_ELEVATION);
            return MOON_ELLIPSOID.cartographicToCartesian(cartographic);
        }

        function generatePath() {
            clearEntities();

            const startLat = parseFloat(document.getElementById('startLat').value);
            const startLon = parseFloat(document.getElementById('startLon').value);
            const endLat = parseFloat(document.getElementById('endLat').value);
            const endLon = parseFloat(document.getElementById('endLon').value);

            const pathPoints = [
                { lat: startLat, lon: startLon },
                { lat: startLat + (endLat - startLat) * 0.25, lon: startLon + (endLon - startLon) * 0.25 },
                { lat: startLat + (endLat - startLat) * 0.5, lon: startLon + (endLon - startLon) * 0.5 },
                { lat: startLat + (endLat - startLat) * 0.75, lon: startLon + (endLon - startLon) * 0.75 },
                { lat: endLat, lon: endLon }
            ];

            const positions = pathPoints.map(point => createCartesianPoint(point.lat, point.lon));

            // Add points
            pathPoints.forEach((point, index) => {
                const pointEntity = viewer.entities.add({
                    position: positions[index],
                    point: {
                        pixelSize: 12,
                        color: index === 0 ? Cesium.Color.LIME.withAlpha(0.9) :
                               index === pathPoints.length - 1 ? Cesium.Color.RED.withAlpha(0.9) :
                               Cesium.Color.YELLOW.withAlpha(0.9),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
                pointEntities.push(pointEntity);
            });

            // Add curved path
            pathEntity = viewer.entities.add({
                polyline: {
                    positions: positions,
                    width: 3,
                    material: new Cesium.PolylineGlowMaterialProperty({
                        glowPower: 0.3,
                        color: Cesium.Color.CYAN.withAlpha(0.9)
                    }),
                    clampToGround: false,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });

            // Add straight line
            const straightLineEntity = viewer.entities.add({
                polyline: {
                    positions: [positions[0], positions[positions.length - 1]],
                    width: 2,
                    material: Cesium.Color.MAGENTA.withAlpha(0.7),
                    clampToGround: false,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });
            pointEntities.push(straightLineEntity);

            const boundingSphere = Cesium.BoundingSphere.fromPoints(positions);
            
            const offset = new Cesium.HeadingPitchRange(
                0,
                -Math.PI/2.5,
                boundingSphere.radius * 2.5
            );
            
            viewer.camera.flyToBoundingSphere(boundingSphere, {
                duration: 1.5,
                offset: offset
            });
        }

        function navigateToLocation() {
            const lat = parseFloat(document.getElementById('navLat').value);
            const lon = parseFloat(document.getElementById('navLon').value);

            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }

            const position = createCartesianPoint(lat, lon);
            
            // Calculate a position for the camera that's above the target location
            const cameraPosition = Cesium.Cartesian3.fromRadians(
                Cesium.Math.toRadians(lon),
                Cesium.Math.toRadians(lat),
                MOON_RADIUS + 100000  // 100 km above the surface
            );

            viewer.camera.flyTo({
                destination: cameraPosition,
                orientation: {
                    heading: 0,
                    pitch: -Cesium.Math.PI_OVER_TWO,  // Looking straight down
                    roll: 0
                },
                duration: 3,
                complete: function() {
                    // Add a marker at the navigated location
                    viewer.entities.add({
                        position: position,
                        point: {
                            pixelSize: 15,
                            color: Cesium.Color.BLUE,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2,
                            disableDepthTestDistance: Number.POSITIVE_INFINITY
                        }
                    });
                }
            });
        }

        function setMaximumLevelOfDetail(tileset) {
            tileset.maximumScreenSpaceError = 2;  // Lower value for higher detail
            viewer.scene.globe.maximumScreenSpaceError = 2;
        }

        async function loadMoonTileset() {
            try {
                const moonTileset = await Cesium.Cesium3DTileset.fromIonAssetId(2684829);
                setMaximumLevelOfDetail(moonTileset);
                viewer.scene.primitives.add(moonTileset);
                viewer.zoomTo(moonTileset, new Cesium.HeadingPitchRange(0, -Math.PI / 4, 3000000)); // Update 2: Modified zoomTo
            } catch (error) {
                console.error('Error loading moon tileset:', error);
            }
        }

        function setInitialView() { // Update 3: Added setInitialView function
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(0, 0, 3000000),
                orientation: {
                    heading: 0,
                    pitch: -Math.PI / 4,
                    roll: 0
                },
                duration: 0
            });
        }

        loadMoonTileset().then(() => { // Update 4: Call setInitialView after loadMoonTileset
            setInitialView();
        });

        // Set default values
        document.getElementById('startLat').value = "0";
        document.getElementById('startLon').value = "0";
        document.getElementById('endLat').value = "5";
        document.getElementById('endLon').value = "5";
        document.getElementById('navLat').value = "-85.28";
        document.getElementById('navLon').value = "31.20";
    </script>
</body>
</html>